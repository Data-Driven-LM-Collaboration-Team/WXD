# 异常图片生成
![](Snipaste_2025-08-06_13-15-02.jpg)
### **现有问题**  

1. **真实异常样本稀缺**：工业场景中产品缺陷罕见，导致训练数据严重不平衡（大量正常样本 vs 极少异常样本）。  
2. **现有异常生成方法效果有限**：
   - **模型无关方法**（如 Crop&Paste）：简单拼接异常纹理到正常图像，生成结果缺乏真实性与上下文一致性（见图1）。
   - **GAN-based 方法**（如 DRAEM）：在异常定位上表现有限，且无法支持异常分类任务；生成质量受限于 GAN 训练不稳定性和模式崩溃问题。  
3. **下游任务受限**：由于缺乏高质量异常数据，现有方法难以同时支持检测、定位和分类三大任务。

---

### **提出的方法**  

AnomalyDiffusion 是一个**条件扩散模型**，其核心流程如下：

1. **输入**：一张正常图像$I_{\text{norm}}$ + 一张异常掩码 \( M \)（指示异常位置与形状）。
2. **掩码生成模块**（基于 Textual Inversion）：
   - 利用少量真实异常掩码学习一个可泛化的“掩码嵌入”；
   - 生成大量多样化的合成掩码，提升异常形态多样性。
3. **扩散生成主干**（U-Net 架构）：
   - 引入 **空间异常嵌入（SAE）**：将掩码编码为位置感知的条件信号；
   - 采用 **掩码扩散损失（Masked Diffusion Loss）**：仅在异常区域计算重建损失；
   - 设计 **自适应注意力重加权机制（AAR）**：利用交叉注意力图与掩码对齐，增强空间一致性。$$
4. **输出**：合成异常图像$`I_{\text{anom}} = I_{\text{norm}} + \text{realistic anomaly at } M`$。

> **图示参考**：论文图1（Bottom）展示了 AnomalyDiffusion 在 hazelnut-crack 和 capsule-squeeze 类别上生成的异常图像，明显比 Crop&Paste 和 DRAEM 更真实、边界更自然。

---

### **方法如何解决问题**  

- **解决数据稀缺**：通过扩散模型强大的生成能力，从 few-shot 异常样本中学习分布，生成大量训练数据。  
- **提升生成真实性**：
  - SAE 和 AAR 确保异常出现在掩码指定位置，且与背景纹理融合自然；
  - 掩码扩散损失聚焦异常区域细节，避免全局模糊。  
- **支持多任务**：生成的图像包含明确异常类型与位置，可直接用于训练分类器（AC）、检测器（AD）和定位模型（AL）。  
- **避免 GAN 缺陷**：扩散模型训练更稳定，生成多样性更高，不易模式崩溃。

---

### **实验结果**  

1. **生成质量评估**：
   - 在 MVTec AD 数据集上，AnomalyDiffusion 在 IS（Inception Score）和 IC-LPIPS（多样性）指标上显著优于 DRAEM、Crop&Paste 等基线。
   - 人工评估显示生成异常更逼真、边界更清晰（见图1）。

2. **下游任务性能**：
   - **异常分类（AC）**：使用生成数据训练 ResNet-34，平均准确率达 **66.09%**，远超 DFMGAN（49.61%）。
   - **异常检测与定位（AD/AL）**：
     - 仅用一个简单 U-Net 在生成数据上训练，在 MVTec 上达到 **95.3% 像素级 AUROC**；
     - 性能媲美或超越当前 SOTA 无监督方法（如 PatchCore、CFLOW），证明生成数据高度可用。

3. **消融实验**：验证了 SAE、AAR 和掩码损失各自对生成质量与任务性能的贡献。

---

综上，AnomalyDiffusion 通过创新的扩散模型架构与条件机制，有效解决了工业异常数据稀缺问题，为少样本异常检测提供了高质量数据增强方案。
